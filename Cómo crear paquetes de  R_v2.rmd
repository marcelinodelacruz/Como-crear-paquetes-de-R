---
title: "Cómo crear paquetes de R \n"
author: "Marcelino de la Cruz Rot^1^, David García-Callejas^2^"
csl: ecosistemas.csl
output:
  word_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 7.5
    highlight: null
    reference_docx: Ecosistemas_template.docx
bibliography:
- references.bib
- knitcitations.bib
---


> (1) Departmento de Biología y Geología, Física y Química Inorgánica. ESCET. Universidad Rey Juan Carlos. Móstoles.
> (2) Estación Biológica de Doñana (CSIC). Américo Vespucio 26, 41092 Sevilla.

> Autor para correspondencia: Marcelino de la Cruz Rot [marcelino.delacruz@urjc.es]


# Palabras clave

> Ciencia reproducible.   


# Keywords

> Reproducible research.


```{r knitcitations, echo=FALSE, cache = FALSE, eval=FALSE}
library(knitcitations)
cleanbib()   
cite_options(citation_format = "pandoc")
```

```{r, eval=F, echo=F}


# CREAR DOCUMENTO:
# library(rmarkdown)
# render("Cómo crear paquetes de  R.rmd")


```

# ¿Por qué crear un paquete de R?

En el lenguaje R, los paquetes son la mejor manera de organizar, mantener y distribuir código y documentación. La motivación más directa para crear un paquete es la facilidad con que permiten compartir código con otros usuarios, pero de igual manera resulta extremadamente útil crear paquetes "de consumo propio", por ejemplo con funciones generales que son utilizadas en diferentes proyectos (véase REF para la creación de funciones en R).

Existen numerosos recursos en internet con consejos y recetas para crear paquetes de R. La referencia fundamental es el manual oficial ["Writing R Extensions"][1], que acompaña cada instalación de R, centrado en la construcción manual, paso a paso, de los paquetes. Además, Wickham [-@Wickham_2015] proporciona una visión alternativa basada en la automatización de las tareas necesarias para la construcción y, sobre todo, el matenimiento de paquetes. En esta sucinta nota, proporcionaremos una visión muy básica de la creación de paquetes usando la funcionalidad de los paquetes `devtools` y `Roxygen2`, desarrollados por Wickham. En todo caso, recomendamos que los usuarios interesados en conocer en detalle la estructura y creación de paquetes se remitan al manual oficial. En dicho manual, además, se detallan los requisitos adicionales para la publicación de paquetes en CRAN, el repositorio oficial de paquetes de R.

# Estructura básica

El primer paso para crear un paquete es la creación de la estructura de directorios asociada al paquete. Si, para nuestro pequeño ejemplo, creamos un paquete que se llama `paqueteR`, lo primero que necesitamos es crear una carpeta con dicho nombre y, dentro de ella, un archivo llamado `DESCRIPTION` (tal cual, sin extensión) que contenga, como mínimo, el siguiente texto:

```{r eval=FALSE}
Package: paqueteR
Version: 0.1
encoding: UTF-8
```
El archivo `DESCRIPTION` puede contener, además de estos campos, multitud de información, desde los autores y dependencias del paquete hasta un resumen del mismo. Además, en este archivo se deben detallar los paquetes auxiliares que, en su caso, utilicemos en las funciones de nuestro propio paquete. En *REF* se puede consultar en detalle el contenido de este importante archivo.

# Añadir y documentar código

El siguiente paso es añadir el código que queremos incluir en nuestro paquete. Siguiendo con nuestro ejemplo, nos gustaría que nuestro `paqueteR` incluya dos funciones:

```{r eval=FALSE}
sqrtfun1 <- function(x) sqrt(x)
sqrtfun2 <- function(x) x^(1/2)
```

En general, es recomendable guardar cada función en un archivo independiente que tenga el mismo nombre que la función. Esto facilita la modularidad del código y evita potenciales duplicidades. En nuestro caso, por tanto, tendríamos un archivo `sqrtfun1.R` y otro `sqrtfun2.R`. Para incluir ambas funciones en nuestro paquete, hemos de crear una carpeta llamada `R` dentro del directorio principal, y mover allí nuestras funciones.

Con estos sencillos pasos ya tenemos la estructura básica de un paquete, pero antes de "construirlo" es necesario documentar nuestro código, para facilitar su distribución y uso por parte de otros usuarios (o de nosotros mismos en un futuro). Generar documentación a través de `Roxygen2` es muy sencillo. Basta con añadir, al comienzo de nuestros archivos .R, una serie de campos que expliquen el uso de la función en cuestión. En nuestras funciones, los archivos documentados tendrían la siguiente forma:

```{r eval=FALSE}
#' Raiz cuadrada 1
#'
#' Función para calcular la raiz cuadrada.
#'
#' @param x Un vector, o array, numérico o complejo
#'
#' @return Raiz cuadrada de x
#' @export
#'
#' @examples sqrt(10)
sqrtfun1 <- function(x) sqrt(x)
```
Como se puede observar, la parte dedicada a la documentación viene distinguida por un caracter especial al comienzo de cada línea (`#'`). La primera línea indica el título de la función, y las siguientes pueden llevar una descripción más detallada de la misma. Cada parámetro viene documentado por un campo `@param`, y el tipo de dato que devuelve la función viene explicado en el campo `@return`. El campo `@export` indica que la función estará disponible para los usuarios del paquete, y en `@examples` podemos incluir ejemplos de uso de nuestra función. Estos campos corresponden exactamente con los que podemos ver en la ayuda de cualquier función de R; existen varios campos más que, por concreción, no detallamos aquí pero pueden ser consultados en la ayuda de `Roxygen2`. Una vez nuestras funciones estén apropiadamente documentadas, y con el directorio de trabajo en el directorio base de nuestro paquete, podemos procesar la documentación con

```{r eval=FALSE}
devtools::document()
```
Si no ha habido ningún problema, esta acción habrá generado un archivo nuevo en nuestro directorio llamado `NAMESPACE`, así como un archivo .Rd en la subcarpeta `MAN` por cada función de nuestro paquete. El "espacio de nombres" es una guía que indica a R 1) si una función del paquete está disponible (una función exportable) o no (una función interna) y 2) dónde se encuentran las funciones de otros paquetes que se emplean dentro del código de nuestras funciones.

# Creación del paquete

Con esta estructura básica, ya tenemos todos los requisitos para construir nuestro `paqueteR`. Para este último paso basta con teclear en la terminal de R (de nuevo, desde la carpeta principal del paquete)

```{r eval=FALSE}
devtools::build()
```
Esta función generará un archivo comprimido .tar.gz con nuestro flamante paquete listo para ser compartido. Para instalar el paquete, basta con teclear el comando

```{r eval=FALSE}
devtools::install()
```
Podemos comprobar si todo ha ido bien cargando nuestro paquete como cualquier otro

```{r eval=FALSE}
library(paqueteR)
```
Además de lo esbozado en esta nota, los paquetes de R pueden incluir conjuntos de datos, y son estructures ideales para trabajar con plataformas de control de versiones como git y el servidor github. En internet se pueden encontrar multitud de tutoriales específicos, entre los cuales recomendamos ...


# Agradecimientos

REMEDINAL TE-CM (S2018/EMT-4338).


###### REFERENCIAS

```{r write_citations, cache=FALSE, include=FALSE, eval=FALSE}
write.bibtex(file = "knitcitations.bib")
#write.bibtex(file = "references.bib")
```

<div id = "refs"></div>



###### PIES DE FIGURA

**Figura 1**. Legenda de la figura 1.



###### FIGURE LEGENDS

**Figure 1**. English legend of FIg. 1.


###### FIGURA 1

```{r Fig1, eval=FALSE, echo=FALSE, fig.cap="Figura 1. Explicación de la figura 1", cache=FALSE}
# plot(dune.o, pch=19, col=2)
```
